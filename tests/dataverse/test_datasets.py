import os
import requests
from time import sleep
from ..conftest import read_json


dir_path = os.path.dirname(os.path.realpath(__file__))
data_path = os.path.join(os.path.dirname(dir_path), "data")


class TestDatasets:
    def test_all_datasets(self):
        INSTANCE = os.getenv("INSTANCE")
        data = read_json(
            os.path.join(data_path, f"instances/{INSTANCE}/test-data.json")
        )
        base_url = data["instance"]["base-url"]

        if data["tests"]["all-datasets"]:
            datasets = read_json(
                os.path.join(data_path, f"instances/{INSTANCE}/datasets.json")
            )

            for ds in datasets:
                url = f"{base_url}/dataset.xhtml?persistentId={ds['pid']}"
                resp = requests.get(url, allow_redirects=True)
                sleep(1)
                assert resp.status_code == 200
                assert resp.encoding == "UTF-8"
                assert resp.url == url

                # Resolve doi.org URL
                url = f"https://doi.org/{ds['pid'][4:]}"
                resp = requests.get(url, allow_redirects=True)
                sleep(1)
                assert resp.status_code == 200
                assert resp.encoding == "UTF-8"

    # def test_dataset_click_around(self, browsers):
    #     for driver in browsers:
    #         INSTANCE = os.getenv("INSTANCE")
    #         data = read_json(os.path.join(data_path, f"instance/dataverse_{INSTANCE}.json"))
    #         base_url = data["instances"][INSTANCE]["base-url"]

    #         # TODO: Check numbers of downloads
    #         driver.get(base_url)
    #         driver.set_window_size(1869, 1025)
    #         # driver.get("https://data.aussda.at/") set to dataset url
    #         driver.find_element(By.CSS_SELECTOR, "tr:nth-child(1) a > span").click()
    #         vars["window_handles"] = driver.window_handles
    #         driver.find_element(By.LINK_TEXT, "doi:10.11587/8VAV6W").click()
    #         # vars["win8453"] = wait_for_window(2000)
    #         vars["root"] = driver.current_window_handle
    #         # driver.switch_to.window(vars["win8453"])
    #         # assert "AUSSDA - The Austrian Social Science Data Archive" in driver.title
    #         # assert "https://aussda.at/" == driver.current_url
    #         driver.close()
    #         driver.switch_to.window(vars["root"])
    #         driver.find_element(By.ID, "citation-select").click()
    #         element = driver.find_element(By.CSS_SELECTOR, "#keywords > .col-sm-9")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).click_and_hold().perform()
    #         element = driver.find_element(By.CSS_SELECTOR, "#keywords > .col-sm-9")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).perform()
    #         element = driver.find_element(By.CSS_SELECTOR, "#keywords > .col-sm-9")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).release().perform()
    #         driver.find_element(By.CSS_SELECTOR, "#keywords > .col-sm-9").click()
    #         element = driver.find_element(By.LINK_TEXT, "doi: https://doi.org/10.1007/978-3-658-25592-3")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).click_and_hold().perform()
    #         element = driver.find_element(By.LINK_TEXT, "doi: https://doi.org/10.1007/978-3-658-25592-3")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).perform()
    #         element = driver.find_element(By.LINK_TEXT, "doi: https://doi.org/10.1007/978-3-658-25592-3")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).release().perform()
    #         vars["window_handles"] = driver.window_handles
    #         driver.find_element(By.LINK_TEXT, "doi: https://doi.org/10.1007/978-3-658-25592-3").click()
    #         vars["win7767"] = wait_for_window(2000)
    #         driver.switch_to.window(vars["win7767"])
    #         # assert "AUSSDA - The Austrian Social Science Data Archive" in driver.title
    #         # assert "https://aussda.at/" == driver.current_url
    #         driver.close()
    #         driver.switch_to.window(vars["root"])
    #         element = driver.find_element(By.LINK_TEXT, "Metadata")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).click_and_hold().perform()
    #         element = driver.find_element(By.LINK_TEXT, "Metadata")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).perform()
    #         element = driver.find_element(By.LINK_TEXT, "Metadata")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).release().perform()
    #         driver.find_element(By.LINK_TEXT, "Metadata").click()
    #         element = driver.find_element(By.LINK_TEXT, "https://elsst.ukdataservice.ac.uk/")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).click_and_hold().perform()
    #         element = driver.find_element(By.LINK_TEXT, "https://elsst.ukdataservice.ac.uk/")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).perform()
    #         element = driver.find_element(By.LINK_TEXT, "https://elsst.ukdataservice.ac.uk/")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).release().perform()
    #         vars["window_handles"] = driver.window_handles
    #         driver.find_element(By.LINK_TEXT, "https://elsst.ukdataservice.ac.uk/").click()
    #         vars["win3282"] = wait_for_window(2000)
    #         driver.switch_to.window(vars["win3282"])
    #         # assert "AUSSDA - The Austrian Social Science Data Archive" in driver.title
    #         # assert "https://aussda.at/" == driver.current_url
    #         driver.close()
    #         driver.switch_to.window(vars["root"])
    #         element = driver.find_element(By.LINK_TEXT, "https://doi.org/10.1007/978-3-658-25592-3")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).click_and_hold().perform()
    #         element = driver.find_element(By.LINK_TEXT, "https://doi.org/10.1007/978-3-658-25592-3")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).perform()
    #         element = driver.find_element(By.LINK_TEXT, "https://doi.org/10.1007/978-3-658-25592-3")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).release().perform()
    #         vars["window_handles"] = driver.window_handles
    #         driver.find_element(By.LINK_TEXT, "https://doi.org/10.1007/978-3-658-25592-3").click()
    #         vars["win529"] = wait_for_window(2000)
    #         driver.switch_to.window(vars["win529"])
    #         # assert "AUSSDA - The Austrian Social Science Data Archive" in driver.title
    #         # assert "https://aussda.at/" == driver.current_url
    #         driver.close()
    #         driver.switch_to.window(vars["root"])
    #         driver.execute_script("window.scrollTo(0,1796)")
    #         element = driver.find_element(By.CSS_SELECTOR, ".panel:nth-child(2) .glyphicon-chevron-down")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).click_and_hold().perform()
    #         element = driver.find_element(By.CSS_SELECTOR, ".panel:nth-child(2) .glyphicon-chevron-down")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).perform()
    #         element = driver.find_element(By.CSS_SELECTOR, ".panel:nth-child(2) .glyphicon-chevron-down")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).release().perform()
    #         driver.find_element(By.CSS_SELECTOR, ".panel:nth-child(2) .glyphicon-chevron-down").click()
    #         element = driver.find_element(By.CSS_SELECTOR, ".glyphicon-chevron-down")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).click_and_hold().perform()
    #         element = driver.find_element(By.CSS_SELECTOR, ".glyphicon-chevron-down")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).perform()
    #         element = driver.find_element(By.CSS_SELECTOR, ".glyphicon-chevron-down")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).release().perform()
    #         driver.find_element(By.CSS_SELECTOR, ".glyphicon-chevron-down").click()
    #         element = driver.find_element(By.LINK_TEXT, "Terms")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).click_and_hold().perform()
    #         element = driver.find_element(By.LINK_TEXT, "Terms")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).perform()
    #         element = driver.find_element(By.LINK_TEXT, "Terms")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).release().perform()
    #         driver.find_element(By.LINK_TEXT, "Terms").click()
    #         element = driver.find_element(By.LINK_TEXT, "Community Norms")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).click_and_hold().perform()
    #         element = driver.find_element(By.LINK_TEXT, "Community Norms")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).perform()
    #         element = driver.find_element(By.LINK_TEXT, "Community Norms")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).release().perform()
    #         vars["window_handles"] = driver.window_handles
    #         driver.find_element(By.LINK_TEXT, "Community Norms").click()
    #         vars["win4537"] = wait_for_window(2000)
    #         driver.switch_to.window(vars["win4537"])
    #         # assert "AUSSDA - The Austrian Social Science Data Archive" in driver.title
    #         # assert "https://aussda.at/" == driver.current_url
    #         driver.close()
    #         driver.switch_to.window(vars["root"])
    #         element = driver.find_element(By.CSS_SELECTOR, "#datasetForm\\3AtabView\\3AtouFragment > .panel-body")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).click_and_hold().perform()
    #         element = driver.find_element(By.CSS_SELECTOR, "#datasetForm\\3AtabView\\3AtouFragment > .panel-body")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).perform()
    #         element = driver.find_element(By.CSS_SELECTOR, "#datasetForm\\3AtabView\\3AtouFragment > .panel-body")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).release().perform()
    #         driver.find_element(By.CSS_SELECTOR, "#datasetForm\\3AtabView\\3AtouFragment > .panel-body").click()
    #         driver.find_element(By.LINK_TEXT, "Versions").click()
    #         driver.execute_script("window.scrollTo(0,36)")
    #         element = driver.find_element(By.ID, "downloadCitation")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).click_and_hold().perform()
    #         element = driver.find_element(By.ID, "downloadCitation")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).perform()
    #         element = driver.find_element(By.ID, "downloadCitation")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).release().perform()
    #         driver.find_element(By.ID, "downloadCitation").click()
    #         element = driver.find_element(By.ID, "datasetForm:endNoteLink")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).click_and_hold().perform()
    #         element = driver.find_element(By.ID, "datasetForm:endNoteLink")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).perform()
    #         element = driver.find_element(By.ID, "datasetForm:endNoteLink")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).release().perform()
    #         driver.find_element(By.ID, "datasetForm:endNoteLink").click()
    #         element = driver.find_element(By.ID, "datasetForm:risLink")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).click_and_hold().perform()
    #         element = driver.find_element(By.ID, "datasetForm:risLink")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).perform()
    #         element = driver.find_element(By.ID, "datasetForm:risLink")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).release().perform()
    #         driver.find_element(By.ID, "datasetForm:risLink").click()
    #         element = driver.find_element(By.ID, "datasetForm:bibLink")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).click_and_hold().perform()
    #         element = driver.find_element(By.ID, "datasetForm:bibLink")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).perform()
    #         element = driver.find_element(By.ID, "datasetForm:bibLink")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).release().perform()
    #         driver.find_element(By.ID, "datasetForm:bibLink").click()
    #         vars["window_handles"] = driver.window_handles
    #         [object Object]
    #         vars["win2987"] = wait_for_window(2000)
    #         element = driver.find_element(By.CSS_SELECTOR, "body")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element, 0, 0).perform()
    #         driver.switch_to.window(vars["win2987"])
    #         # assert "AUSSDA - The Austrian Social Science Data Archive" in driver.title
    #         # assert "https://aussda.at/" == driver.current_url
    #         driver.close()
    #         driver.switch_to.window(vars["root"])
    #         element = driver.find_element(By.CSS_SELECTOR, "body")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).click_and_hold().perform()
    #         element = driver.find_element(By.CSS_SELECTOR, "body")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).perform()
    #         element = driver.find_element(By.CSS_SELECTOR, "body")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).release().perform()
    #         driver.find_element(By.CSS_SELECTOR, "body").click()
    #         driver.find_element(By.ID, "downloadCitation").click()
    #         element = driver.find_element(By.LINK_TEXT, "Metadata")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).click_and_hold().perform()
    #         element = driver.find_element(By.LINK_TEXT, "Metadata")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).perform()
    #         element = driver.find_element(By.LINK_TEXT, "Metadata")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).release().perform()
    #         driver.find_element(By.LINK_TEXT, "Metadata").click()
    #         driver.execute_script("window.scrollTo(0,378)")
    #         element = driver.find_element(By.CSS_SELECTOR, ".btn-group > .dropdown-toggle")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).click_and_hold().perform()
    #         element = driver.find_element(By.CSS_SELECTOR, ".btn-group > .dropdown-toggle")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).perform()
    #         element = driver.find_element(By.CSS_SELECTOR, ".btn-group > .dropdown-toggle")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).release().perform()
    #         driver.find_element(By.CSS_SELECTOR, ".btn-group > .dropdown-toggle").click()
    #         element = driver.find_element(By.LINK_TEXT, "Dublin Core")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).click_and_hold().perform()
    #         element = driver.find_element(By.LINK_TEXT, "Dublin Core")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).perform()
    #         element = driver.find_element(By.LINK_TEXT, "Dublin Core")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).release().perform()
    #         vars["window_handles"] = driver.window_handles
    #         driver.find_element(By.LINK_TEXT, "Dublin Core").click()
    #         vars["win5059"] = wait_for_window(2000)
    #         driver.switch_to.window(vars["win5059"])
    #         # assert "AUSSDA - The Austrian Social Science Data Archive" in driver.title
    #         # assert "https://aussda.at/" == driver.current_url
    #         driver.close()
    #         driver.switch_to.window(vars["root"])
    #         element = driver.find_element(By.CSS_SELECTOR, ".navbar-brand")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).perform()
    #         element = driver.find_element(By.CSS_SELECTOR, "body")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element, 0, 0).perform()
    #         element = driver.find_element(By.LINK_TEXT, "DDI")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).click_and_hold().perform()
    #         element = driver.find_element(By.LINK_TEXT, "DDI")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).perform()
    #         element = driver.find_element(By.LINK_TEXT, "DDI")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).release().perform()
    #         vars["window_handles"] = driver.window_handles
    #         driver.find_element(By.LINK_TEXT, "DDI").click()
    #         vars["win2882"] = wait_for_window(2000)
    #         driver.switch_to.window(vars["win2882"])
    #         # assert "AUSSDA - The Austrian Social Science Data Archive" in driver.title
    #         # assert "https://aussda.at/" == driver.current_url
    #         driver.close()
    #         driver.switch_to.window(vars["root"])
    #         element = driver.find_element(By.LINK_TEXT, "JSON")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).click_and_hold().perform()
    #         element = driver.find_element(By.LINK_TEXT, "JSON")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).perform()
    #         element = driver.find_element(By.LINK_TEXT, "JSON")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).release().perform()
    #         vars["window_handles"] = driver.window_handles
    #         driver.find_element(By.LINK_TEXT, "JSON").click()
    #         vars["win716"] = wait_for_window(2000)
    #         driver.switch_to.window(vars["win716"])
    #         # assert "AUSSDA - The Austrian Social Science Data Archive" in driver.title
    #         # assert "https://aussda.at/" == driver.current_url
    #         driver.close()
    #         driver.switch_to.window(vars["root"])
    #         element = driver.find_element(By.CSS_SELECTOR, "body")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).click_and_hold().perform()
    #         element = driver.find_element(By.CSS_SELECTOR, "body")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).perform()
    #         element = driver.find_element(By.CSS_SELECTOR, "body")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).release().perform()
    #         driver.find_element(By.CSS_SELECTOR, "body").click()
    #         element = driver.find_element(By.CSS_SELECTOR, "html")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).click_and_hold().perform()
    #         element = driver.find_element(By.CSS_SELECTOR, "html")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).perform()
    #         element = driver.find_element(By.CSS_SELECTOR, "html")
    #         actions = ActionChains(driver)
    #         actions.move_to_element(element).release().perform()
    #         # assert "AUSSDA - The Austrian Social Science Data Archive" in driver.title
    #         # assert "https://aussda.at/" == driver.current_url
